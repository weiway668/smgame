<!--pages/maze/maze.wxml-->
<!-- 迷宫游戏页面 -->

<view class="container">
  <!-- 游戏画布 - 全屏显示 -->
  <view class="game-canvas-wrapper">
    <!-- Canvas容器，确保相对定位 -->
    <view class="canvas-container" style="position: relative; width: {{canvasWidth}}px; height: {{canvasHeight}}px; z-index: 1;">
      <canvas 
        type="2d"
        id="mazeCanvas"
        class="game-canvas"
        style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
      ></canvas>
      
      <!-- 透明覆盖层处理所有交互，确保完全覆盖Canvas -->
      <view 
        class="touch-layer"
        style="width: {{canvasWidth}}px; height: {{canvasHeight}}px;"
        bindtap="handleTap"
        bindtouchstart="touchStart"
        bindtouchend="touchEnd"
      ></view>
    </view>
    
    <!-- 悬浮统计信息 -->
    <view class="floating-stats">
      <view class="floating-stat-item left">
        <text class="stat-icon">👣</text>
        <text class="stat-value">{{steps}}</text>
      </view>
      <view class="floating-stat-item right">
        <text class="stat-icon">⏱</text>
        <text class="stat-value">{{time}}s</text>
      </view>
    </view>
    
    <!-- 游戏状态覆盖层 - 移到canvas-container之后确保显示在上层 -->
    <view class="game-overlay" wx:if="{{gameStatus === 'ready'}}">
      <view class="overlay-content">
        <text class="overlay-title">准备开始</text>
        <text class="overlay-desc">点击目标位置或滑动移动</text>
        <button class="btn-start" bindtap="startGame">开始游戏</button>
      </view>
    </view>
    
    <view class="game-overlay" wx:if="{{gameStatus === 'paused'}}">
      <view class="overlay-content">
        <text class="overlay-title">游戏暂停</text>
        <button class="btn-resume" bindtap="resumeGame">继续游戏</button>
        <button class="btn-restart" bindtap="restartGame">重新开始</button>
      </view>
    </view>
    
    <!-- 游戏胜利覆盖层 - 移到canvas-container之后确保显示在上层 -->
    <view class="game-overlay" wx:if="{{gameStatus === 'win'}}">
      <view class="overlay-content">
        <text class="overlay-title">🎉 恭喜通关！</text>
        <text class="overlay-desc">{{difficulty === 'easy' ? '简单' : difficulty === 'medium' ? '中等' : '困难'}}难度完成</text>
        
        <view class="win-stats">
          <text class="stat-line">✨ 步数：{{steps}} 步</text>
          <text class="stat-line">⏱ 用时：{{time}} 秒</text>
          <text class="stat-line" wx:if="{{bestSteps && steps <= bestSteps}}">🏆 新纪录！</text>
        </view>
        
        <!-- 进阶模式按钮 -->
        <block wx:if="{{progressionMode && difficulty !== 'hard'}}">
          <text class="overlay-hint">准备好挑战更高难度了吗？</text>
          <button class="btn-next" bindtap="nextLevel">
            挑战{{difficulty === 'easy' ? '中等' : '困难'}}难度
          </button>
          <button class="btn-replay" bindtap="restartGame">重玩当前</button>
        </block>
        
        <!-- 非进阶模式或最高难度按钮 -->
        <block wx:else>
          <text class="overlay-hint" wx:if="{{difficulty === 'hard'}}">你已征服最高难度！</text>
          <button class="btn-next" bindtap="restartGame">再来一局</button>
          <button class="btn-back" bindtap="backToMenu">返回主页</button>
        </block>
      </view>
    </view>
  </view>
</view>

<!-- 浮动菜单按钮 -->
<view class="menu-button {{menuOpen ? 'active' : ''}}" bindtap="toggleMenu">
  <text class="menu-icon">⚙</text>
</view>

<!-- 菜单遮罩 -->
<view class="menu-overlay" wx:if="{{menuOpen}}" bindtap="closeMenu"></view>

<!-- 浮动菜单面板 -->
<view class="menu-panel {{menuOpen ? 'open' : ''}}" wx:if="{{menuOpen}}">
  <!-- 菜单内容 -->
  <view class="menu-content">
    <!-- 难度选择 -->
    <view class="menu-section">
      <text class="menu-label">难度选择</text>
      <view class="difficulty-options">
        <button 
          wx:for="{{difficulties}}" 
          wx:key="value"
          class="difficulty-btn {{difficulty === item.value ? 'active' : ''}}"
          bindtap="selectDifficulty"
          data-difficulty="{{item.value}}"
        >
          {{item.label}}
        </button>
      </view>
    </view>
    
    <!-- 游戏控制 -->
    <view class="menu-section">
      <button class="menu-btn" bindtap="restartGame">
        <text class="menu-btn-icon">↻</text>
        <text class="menu-btn-text">重新开始</text>
      </button>
      
      <button 
        class="menu-btn" 
        bindtap="{{gameStatus === 'playing' ? 'pauseGame' : 'resumeGame'}}"
        wx:if="{{gameStatus === 'playing' || gameStatus === 'paused'}}"
      >
        <text class="menu-btn-icon">{{gameStatus === 'playing' ? '⏸' : '▶'}}</text>
        <text class="menu-btn-text">{{gameStatus === 'playing' ? '暂停游戏' : '继续游戏'}}</text>
      </button>
      
      <button class="menu-btn {{showHint ? 'active' : ''}}" bindtap="toggleHint">
        <text class="menu-btn-icon">💡</text>
        <text class="menu-btn-text">{{showHint ? '隐藏提示' : '显示提示'}}</text>
      </button>
      
      <button class="menu-btn {{progressionMode ? 'active' : ''}}" bindtap="toggleProgressionMode">
        <text class="menu-btn-icon">📈</text>
        <text class="menu-btn-text">{{progressionMode ? '进阶模式开' : '进阶模式关'}}</text>
      </button>
    </view>
  </view>
</view>
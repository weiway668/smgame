<!--pages/maze/maze.wxml-->
<!-- WXML渲染版本 -->
<view class="container">
  <view class="top-bar">
    <view class="level-indicator">第 {{currentLevel > 20 ? 20 : currentLevel}} 关</view>
  </view>

  <!-- 游戏区域 -->
  <view class="game-wrapper"
    bindtouchstart="touchStart"
    bindtouchend="touchEnd"
    bindtap="handleTap"
  >
    <view class="maze-grid" style="width: 90vmin; height: 90vmin;">
      <!-- 迷宫行 -->
      <view class="maze-row" wx:for="{{maze}}" wx:for-item="row" wx:key="index">
        <!-- 迷宫单元格 (使用wx:if保证渲染正确) -->
        <block wx:for="{{row}}" wx:for-item="cell" wx:key="index">
          <view wx:if="{{cell === 1}}" class="maze-cell wall"></view>
          <view wx:elif="{{cell === 2}}" class="maze-cell start"></view>
          <view wx:elif="{{cell === 3}}" class="maze-cell end"></view>
          <view wx:else class="maze-cell path"></view>
        </block>
      </view>

      <!-- 玩家 -->
      <view class="player" style="{{playerStyle}}; width: {{100/mazeWidth}}%; height: {{100/mazeHeight}}%;"></view>

      <!-- 路径标记 -->
      <view 
        class="trail-cell"
        wx:for="{{visitedCells}}"
        wx:key="*this"
        style="top: {{(item[1] / mazeHeight) * 100}}%; left: {{(item[0] / mazeWidth) * 100}}%; width: {{100/mazeWidth}}%; height: {{100/mazeHeight}}%;"
      ></view>

      <!-- 答案路径 -->
      <view 
        class="solution-cell"
        wx:for="{{solutionPath}}"
        wx:key="*this"
        style="top: {{(item[1] / mazeHeight) * 100}}%; left: {{(item[0] / mazeWidth) * 100}}%; width: {{100/mazeWidth}}%; height: {{100/mazeHeight}}%;"
      ></view>
    </view>
  </view>

  <!-- 游戏状态覆盖层 -->
    <view class="game-overlay" wx:if="{{gameStatus === 'ready' && isOverlayVisible}}">
    <view class="overlay-content">
      <text class="overlay-title">第 {{currentLevel}} 关</text>
      <text class="overlay-desc">滑动屏幕，走出迷宫</text>
      <button class="btn-start" bindtap="startGame">开始挑战</button>
    </view>
  </view>
  
  <view class="game-overlay" wx:if="{{gameStatus === 'win' && isOverlayVisible}}">
    <view class="overlay-content">
      <block wx:if="{{allLevelsCompleted}}">
        <text class="overlay-title">🎉 恭喜通关！</text>
        <text class="overlay-desc">你已是真正的迷宫大师！</text>
        <button class="btn-next" bindtap="nextLevel">从第一关开始</button>
      </block>
      <block wx:else>
        <text class="overlay-title">🎉 第 {{currentLevel - 1}} 关完成！</text>
        <view class="win-stats">
          <text class="stat-line">✨ 步数：{{steps}} 步</text>
          <text class="stat-line">⏱ 用时：{{time}} 秒</text>
        </view>
        <button class="btn-next" bindtap="nextLevel">下一关</button>
      </block>
    </view>
  </view>

  <view class="game-overlay" wx:if="{{gameStatus === 'lose' && isOverlayVisible}}">
    <view class="overlay-content">
      <text class="overlay-title">⌛️ 时间到！</text>
      <text class="overlay-desc">再快一点就成功啦！</text>
      <button class="btn-restart" bindtap="restartGame">重新挑战</button>
      <button class="btn-back" bindtap="showSolution">查看答案</button>
    </view>
  </view>

  <!-- 底部统计与控制 -->
  <view class="bottom-bar">
    <view class="stats-container">
        <view class="stat-item"><text class="stat-icon">👣</text> {{steps}}</view>
        <view class="stat-item"><text class="stat-icon">⏱</text> {{time}} / {{timeLimit}}s</view>
    </view>
    <view class="restart-button-wrapper">
        <view class="restart-btn" bindtap="restartGame">↻</view>
    </view>
  </view>
</view>
